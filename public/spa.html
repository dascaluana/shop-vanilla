<html>
<head>

    <!-- Load the jQuery JS library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <!-- Custom JS script -->
    <script type="text/javascript">

        /**
         * A function that takes a products array and renders it's html
         *
         * The products array must be in the form of
         * [{
         *     "title": "Product 1 title",
         *     "description": "Product 1 desc",
         *     "price": 1
         * },{
         *     "title": "Product 2 title",
         *     "description": "Product 2 desc",
         *     "price": 2
         * }]
         */
        function renderList(products, name) {
            var html = [
                    '<tr>',
                    '<th>Title</th>',
                    '<th>Description</th>',
                    '<th>Price</th>',
                    '<th>Image</th>',
                ],
                action = '';

            if (name === 'products') {
                action = 'Edit/Delete'
            } else if (name === 'index') {
                action = 'Add';
            } else {
                action = 'Remove';
            }

            html.push('<th>' + action + '</th>');
            html.push('</tr>');

            html = html.join('');

            $.each(products, function (key, product) {
                html += [
                    '<tr>',
                    '<td>' + product.title + '</td>',
                    '<td>' + product.description + '</td>',
                    '<td>' + product.price + '</td>',
                    '<td><img src="storage/images/' + product.image + '" width="50" height="50"/></td>',
                ].join('');

                if (name === 'products') {
                    html += [
                        '<td align="center">',
                        '<a href="#save?id=' + product.id + '">Edit</a><br />',
                        '<a product-id="' + product.id + '" class="deleteProd" href="#">Delete</a>',
                        '</tr>',
                    ].join('');
                } else if (name === 'index') {
                    html += [
                        '<td><a product-id="' + product.id + '" class="addCart" href="#">Add</a></td>',
                        '</tr>'
                    ].join('');
                } else {
                    html += [
                        '<td><a product-id="' + product.id + '" class="removeCart" href="#">Remove</a></td>',
                        '</tr>'
                    ].join('');
                }
            });

            return html;

        }

        function renderOrders(orders) {
            var html = [
                    '<tr>',
                    '<th>Date</th>',
                    '<th>Name</th>',
                    '<th>Email</th>',
                    '<th>Comments</th>',
                    '<th>Product</th>',
                    '<th>View</th>',
                    '</tr>',
                ].join('');

            $.each(orders, function (key, order) {
                html += [
                    '<tr>',
                    '<td align="center">' + order.created_at + '</td>',
                    '<td>' + order.name + '</td>',
                    '<td>' + order.email + '</td>',
                    '<td align="center">' + order.comments + '</td>',
                ].join('');

                var productsList = '';
                if (order.products && order.products.length) {
                    $.each(order.products, function (key, product) {
                        productsList += '- ' + product.title + '<br />';
                    });
                }

                html += [
                    '<td>' + productsList + '</td>',
                    '<td><a href="#order?id=' + order.id + '">View</a></td>',
                    '</tr>'
                ].join('');
            });

            return html;
        }

        function renderOrder(order) {
            var html = [
                '<tr>',
                '<td>',
                '<b>Name:</b>',
                '</td>',
                '<td>' + order.name + '</td>',
                '</tr>',

                '<tr>',
                '<td>',
                '<b>Email:</b>',
                '</td>',
                '<td>' + order.email + '</td>',
                '</tr>',

                '<tr>',
                '<td>',
                '<b>Comments:</b>',
                '</td>',
                '<td>' + order.comments + '</td>',
                '</tr>',

                '<tr>',
                '<td>',
                '<b>Date:</b>',
                '</td>',
                '<td>' + order.created_at + '</td>',
                '</tr>',
            ].join('');

            if (order.products && order.products.length) {
                html += [
                    '<tr>',
                    '<th>Title</th>',
                    '<th>Description</th>',
                    '<th>Price</th>',
                    '<th>Image</th>',
                    '</tr>',
                ].join('');


                $.each(order.products, function (key, product) {
                    html += [
                        '<tr>',
                        '<td>' + product.title + '</td>',
                        '<td>' + product.description + '</td>',
                        '<td>' + product.image + '</td>',
                        '<td><img src="storage/images/' + product.image + '" width="50" height="50"/></td>',
                        '</tr>'
                    ].join('');
                });
            }

            return html;
        }

        function renderSaveForm(product) {

            var html = [
                '<tr>',
                    '<td>Title:</td>',
                    '<td>',
                        '<input type="text" name="title" value="' + product.title + '">',
                        '<div class="errors err-title"></div>',
                    '</td>',
                '</tr>',

                '<tr>',
                    '<td>Description:</td>',
                    '<td>',
                        '<textarea type="text" name="description" rows="5" cols="22">' + product.description + '</textarea>',
                        '<div class="errors err-description"></div>',
                    '</td>',
                '</tr>',

                '<tr>',
                    '<td>Price:</td>',
                    '<td>',
                        '<input type="text" name="price"  value="' + product.price + '">',
                        '<div class="errors err-price"></div>',
                    '</td>',
                '</tr>',

                '<tr>',
                    '<td>Image:</td>',
                    '<td>',
                        (product.image && product.image.length ? '<img src="storage/images/' + product.image + '" width="50" height="50">' : ''),
                        '<input type="file" name="image" id="image">',
                        '<div class="errors err-image"></div>',
                    '</td>',
                '</tr>',

                '<tr>',
                    '<td><a href="#products">Products</a></td>',
                    '<td><input type="submit" name="submit" value="Save"/></td>',
                '</tr>'
            ].join('');

            return html;
        }

        function displayProducts (name) {
            $.ajax('/' + name, {
                dataType: 'json'
            })
            .done(function (response) {
                // Render the products in the index list
                if (response.length === 0) {
                    if (name === 'cart') {
                        $('.emailForm').hide();
                    }
                    $('.' + name + ' .list').html(emptyCart());
                } else {
                    if (name === 'cart') {
                        $('.emailForm').show();
                    }
                    $('.' + name + ' .list').html(renderList(response, name));
                }
            })
            .fail(function () {
                window.location = '#login';
            })
        }

        function emptyCart () {
            var html = [
                '<p>No products</p>',
            ].join('');
            return html;
        }

        function saveProduct (form) {
            var id = $(form).attr('product-id'),
                url = "/products";

            if (id && id.length) {
                url += id + '?_method=PUT';
            }

            $('.errors').html('').hide();

            $.ajax({
                type: 'POST',
                url: url,
                data: new FormData(form),
                contentType: false,
                processData: false,
                dataType: 'json'
            })
            .done(function () {
                window.location = '#products';
            })
            .fail(function (response) {
                console.log(response);

                if (!response.responseJSON || !response.responseJSON.errors) {
                    return;
                }

                for (var item in response.responseJSON.errors) {
                    $('.err-' + item).html(response.responseJSON.errors[item].join('<br />')).show();
                }

            });
        }

        $(document).on('click', '.addCart', function(e) {
            e.preventDefault();

            var id = $(this).attr('product-id');
            $.ajax({
                url: '/index/' + id,
                method: 'GET',
                dataType: 'json',
            })
            .done(function () {
                displayProducts('index');
            });
        });

        $(document).on('click', '.removeCart', function(e) {
            e.preventDefault();

            var id = $(this).attr('product-id');
            $.ajax({
                url: '/cart/' + id,
                method: 'GET',
                dataType: 'json',
            })
            .done(function () {
                displayProducts('cart');
            });
        });

        $(document).on('click', '.deleteProd', function(e) {
            e.preventDefault();

            var id = $(this).attr('product-id');
            $.ajax({
                url: '/products/' + id,
                method: 'DELETE',
                dataType: 'json',
            })
            .done(function () {
                displayProducts('products');
            });
        });

        $(document).on('submit', '.emailForm', function (e) {
            e.preventDefault();

            var form = $(this);
            $.ajax({
                type: 'POST',
                url: '/cart',
                data: form.serialize(),
                dataType: 'json'
            })
                .done(function () {
                    $('.cart .list').html(emptyCart());
                });
        });

        $(document).on('submit', '.saveForm', function (e) {
            e.preventDefault();

            saveProduct(this);
        });

        $(document).on('submit', '.loginForm', function (e) {
            e.preventDefault();

            var form = $(this);

            $('.errors').html('').hide();

            $.ajax({
                type: 'POST',
                url: '/login',
                data: form.serialize(),
            })
            .done(function () {
                window.location = '#products';
            })
            .fail(function (response) {
                console.log(response);

                if (!response.responseJSON || !response.responseJSON.errors) {
                    return;
                }

                for (var item in response.responseJSON.errors) {
                    $('.err-' + item).html(response.responseJSON.errors[item].join('<br />')).show();
                }

            });
        });

        $(document).on('click', '.logout', function(e) {
            e.preventDefault();

            $.ajax({
                url: '/logout' ,
                method: 'GET',
            })
            .done(function () {
                window.location = '#login';
            });
        });

        $(document).ready(function () {

            /**
             * URL hash change handler
             */
            window.onhashchange = function () {
                var hash = document.URL.substr(document.URL.indexOf('#') +1 ),
                    pos = hash.indexOf('?'),
                    page = hash,
                    params = [];

                if (pos !== -1) {
                    page = hash.substr(0, pos);

                    hash.substr(pos + 1)
                        .split('&')
                        .forEach(function (v, k) {
                            var explode = v.split('=');
                            params[explode[0]] = explode[1];
                        });
                }

                // First hide all the pages
                $('.page').hide();

                switch (page) {
                    case 'cart':
                        // Show the cart page
                        $('.cart').show();

                        // Load the cart products from the server
                        displayProducts('cart');
                        break;
                    case 'products':
                        // Show the products page
                        $('.products').show();

                        // Load the products from the server
                        displayProducts('products');
                        break;
                    case 'save':
                        // Show the products page

                        var product = {
                                id: "",
                                title: "",
                                description: "",
                                price: "",
                                image: ""
                            };

                        if (params.id) {
                            $.ajax('/products/' + params.id, {
                                dataType: 'json'
                            })
                            .done(function (response) {
                                $('.save .saveForm').attr('product-id', response.id);
                                product = response;

                                $('.save .tableProd').html(renderSaveForm(product));
                                $('.save').show();
                            });
                        } else {
                            $('.save .tableProd').html(renderSaveForm(product));
                            $('.save').show();
                        }

                        break;
                    case 'orders':
                        $('.orders').show();

                        $.ajax('/orders', {
                            dataType: 'json'
                        })
                        .done(function (response) {
                            $('.orders .list').html(renderOrders(response));
                        })
                        .fail(function () {
                            window.location = '#login';
                        });

                        break;
                    case 'order':
                        $.ajax('/order/' + params.id, {
                            dataType: 'json'
                        })
                        .done(function (response) {
                            $('.order .list').html(renderOrder(response));
                            $('.order').show();
                        })
                        .fail(function () {
                            window.location = '#login';
                        });

                        break;
                    case 'login':
                        $('.login').show();

                        break;
                    default:
                        // If all else fails, always default to index
                        // Show the index page
                        $('.index').show();

                        // Load the index products from the server
                        displayProducts('index');
                        break;
                }
            };

            window.onhashchange();
        });
    </script>
</head>
<body>
<!-- The index page -->
<div class="page index" style="display: none;">
    <!-- The index element where the products list is rendered -->
    <table class="list"></table>

    <!-- A link to go to the cart by changing the hash -->
    <a href="#cart" class="button">Go to cart</a>
</div>

<!-- The cart page -->
<div class="page cart" style="display: none;">
    <!-- The cart element where the products list is rendered -->
    <table class="list"></table>

    <form class="emailForm" action="" method="post">
        <table>
            <tr>
                <td>Name:</td>
                <td><input type="text" name="name" value=""></td>
            </tr>

            <tr>
                <td>Email:</td>
                <td><input type="text" name="email" value=""></td>
            </tr>

            <tr>
                <td>Comments:</td>
                <td><textarea name="comments" rows="5" cols="22"></textarea></td>
            </tr>

            <tr>
                <td><input type="submit" name="submit" value="Checkout"/></td>
            </tr>
        </table>
    </form>

    <!-- A link to go to the index by changing the hash -->
    <a href="#" class="button">Go to index</a>
</div>

<!-- The products page -->
<div class="page products" style="display: none;">
    <!-- The index element where the products list is rendered -->
    <table class="list"></table>

    <a href="#save" class="button">Add</a>
    <a href="#logout" class="logout">Logout</a>
</div>

<!-- The edit page -->
<div class="page save" style="display: none;">
    <form class="saveForm">
        <table class="tableProd"></table>
    </form>
</div>

<!-- The orders page -->
<div class="page orders" style="display: none;">
    <!-- The index element where the orders list is rendered -->
    <table class="list" border="1"></table>
</div>

<!-- The order page -->
<div class="page order" style="display: none;">
    <!-- The index element where the products list and order is rendered -->
    <table class="list"></table>

    <a href="#orders">Orders</a>
</div>

<!-- The login page -->
<div class="page login" style="display: none;">
    <form class="loginForm">
        <input type="text" name="email" placeholder="Username"><br />
        <div class="errors err-email"></div>
        <input type="password" name="password" placeholder="Password"><br />
        <div class="errors err-password"></div>
        <input type="submit" value="Log in">
    </form>
</div>
</body>
</html>
